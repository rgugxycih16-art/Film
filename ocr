<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>二维码文字互转工具</title>

  <!-- 二维码生成库：换成浏览器兼容更好的 qrcodejs -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- 二维码识别库 -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:linear-gradient(135deg,#ff9a56 0%,#ff6a00 50%,#ff4500 100%);
      min-height:100vh; padding:20px;
    }
    .container { max-width:600px; margin:0 auto; background:#fff; border-radius:20px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
    h1 { text-align:center; color:#333; margin-bottom:10px; font-size:28px; }
    .subtitle { text-align:center; color:#666; margin-bottom:30px; font-size:14px; }
    .tabs { display:flex; gap:10px; margin-bottom:30px; background:#fff5f0; padding:5px; border-radius:15px; }
    .tab { flex:1; padding:12px; border:none; background:transparent; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:.3s; color:#ff6a00; }
    .tab.active { background:linear-gradient(135deg,#ff9a56,#ff6a00); color:#fff; box-shadow:0 4px 15px rgba(255,106,0,.4); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .input-group { margin-bottom:20px; }
    .input-group label { display:block; margin-bottom:8px; color:#333; font-weight:600; }
    textarea {
      width:100%; min-height:120px; padding:15px; border:2px solid #e0e0e0; border-radius:10px;
      font-size:15px; font-family:inherit; resize:vertical; transition:border-color .3s;
    }
    textarea:focus { outline:none; border-color:#ff6a00; }
    .size-selector { display:flex; gap:10px; margin-bottom:20px; }
    .size-selector label { flex:1; }
    .size-selector select {
      width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px;
    }
    button {
      width:100%; padding:15px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:.3s;
    }
    .btn-primary { background:linear-gradient(135deg,#ff9a56,#ff6a00); color:#fff; margin-bottom:20px; }
    .btn-primary:active { transform:scale(.98); }
    .btn-secondary { background:#fff5f0; color:#ff6a00; margin-bottom:10px; }
    .qr-result { text-align:center; margin-top:20px; display:none; }
    #qrBox { width:100%; display:grid; place-items:center; margin-top:10px; }
    #qrBox canvas, #qrBox img {
      max-width:100%; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,.1); margin-bottom:15px;
    }
    .upload-area {
      border:3px dashed #ff6a00; border-radius:15px; padding:40px 20px; text-align:center; cursor:pointer;
      transition:.3s; background:#fff5f0; margin-bottom:20px;
    }
    .upload-area:hover { border-color:#ff4500; background:#ffebe0; }
    .upload-area.dragover { border-color:#ff4500; background:#ffe0d0; transform:scale(1.02); }
    .upload-icon { font-size:48px; margin-bottom:10px; }
    .upload-text { color:#ff6a00; font-size:16px; font-weight:600; }
    .upload-hint { color:#999; font-size:12px; margin-top:5px; }
    #fileInput { display:none; }
    .scan-buttons { display:flex; gap:10px; margin-bottom:20px; }
    .scan-buttons button { flex:1; }
    #preview { max-width:100%; border-radius:10px; margin-bottom:20px; display:none; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    .decode-result { display:none; margin-top:20px; }
    .result-label { font-weight:600; color:#333; margin-bottom:10px; }
    #decodeText {
      width:100%; min-height:120px; padding:15px; border:2px solid #e0e0e0; border-radius:10px;
      font-size:15px; line-height:1.6; resize:vertical; font-family:inherit; margin-bottom:10px;
    }
    .action-buttons { display:flex; gap:10px; }
    .action-buttons button { flex:1; }
    #videoContainer { display:none; position:relative; margin-bottom:20px; }
    #video { width:100%; border-radius:10px; background:#000; }
    #scanOverlay {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:200px; height:200px; border:3px solid #00ff00; border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,.5);
    }
    .footer { text-align:center; margin-top:20px; color:#999; font-size:12px; }
    @media (max-width:480px) { .container{padding:20px;} h1{font-size:24px;} .upload-area{padding:30px 15px;} }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔲 二维码工具</h1>
    <p class="subtitle">文字与二维码互相转换</p>

    <div class="tabs">
      <!-- 传入 event，避免 Safari 无全局 event 报错 -->
      <button class="tab active" onclick="switchTab(event, 'generate')">📝 生成二维码</button>
      <button class="tab" onclick="switchTab(event, 'scan')">📷 扫描二维码</button>
    </div>

    <!-- 文字 -> 二维码 -->
    <div id="generate" class="tab-content active">
      <div class="input-group">
        <label for="inputText">输入文字内容:</label>
        <textarea id="inputText" placeholder="输入要生成二维码的文字、网址或其他内容..."></textarea>
      </div>

      <div class="size-selector">
        <label>
          大小:
          <select id="qrSize">
            <option value="200">小 (200x200)</option>
            <option value="300" selected>中 (300x300)</option>
            <option value="400">大 (400x400)</option>
            <option value="500">超大 (500x500)</option>
          </select>
        </label>
        <label>
          纠错级别:
          <select id="errorLevel">
            <option value="L">低 (L)</option>
            <option value="M" selected>中 (M)</option>
            <option value="Q">较高 (Q)</option>
            <option value="H">高 (H)</option>
          </select>
        </label>
      </div>

      <button class="btn-primary" onclick="generateQR()">🔲 生成二维码</button>

      <div class="qr-result" id="qrResult">
        <!-- 用 qrcodejs：需要一个容器，而不是固定的 <canvas> -->
        <div id="qrBox" aria-label="QR Code"></div>
        <button class="btn-secondary" onclick="downloadQR()">💾 下载二维码</button>
        <button class="btn-secondary" onclick="shareQR()">📤 分享二维码</button>
      </div>
    </div>

    <!-- 二维码 -> 文字 -->
    <div id="scan" class="tab-content">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📸</div>
        <div class="upload-text">点击选择二维码图片或拖放到此处</div>
        <div class="upload-hint">支持 JPG、PNG 等格式</div>
      </div>
      <input type="file" id="fileInput" accept="image/*" />

      <div class="scan-buttons">
        <button class="btn-primary" onclick="openCamera()">📷 拍照扫描</button>
        <button class="btn-secondary" onclick="openGallery()">🖼️ 相册选择</button>
      </div>

      <button class="btn-primary" id="liveButton" onclick="startLiveScan()">📹 实时扫描</button>

      <div id="videoContainer">
        <video id="video" autoplay playsinline></video>
        <div id="scanOverlay"></div>
        <button class="btn-secondary" onclick="stopLiveScan()">⏹️ 停止扫描</button>
      </div>

      <img id="preview" alt="预览图片" />

      <div class="decode-result" id="decodeResult">
        <div class="result-label">识别结果:</div>
        <textarea id="decodeText" readonly></textarea>
        <div class="action-buttons">
          <button class="btn-primary" onclick="copyResult()">📋 复制</button>
          <button class="btn-secondary" onclick="openLink()">🔗 打开链接</button>
          <button class="btn-secondary" onclick="resetScan()">🔄 重新扫描</button>
        </div>
      </div>
    </div>

    <div class="footer">所有处理在本地完成，保护您的隐私</div>
  </div>

  <script>
    let videoStream = null;
    let scanning = false;
    let qr; // qrcodejs 实例

    // Tab 切换（显式接收 event）
    function switchTab(ev, tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      if (tabName === 'generate') stopLiveScan();
    }

    // ========= 文字 -> 二维码 =========
    function generateQR() {
      const value = (document.getElementById('inputText').value || '').trim();
      const size = parseInt(document.getElementById('qrSize').value, 10);
      const level = document.getElementById('errorLevel').value;

      if (!value) { alert('请输入要生成二维码的内容！'); return; }

      const box = document.getElementById('qrBox');
      box.innerHTML = ''; // 清空旧的
      // qrcodejs：H(最高)、Q、M、L(最低)
      const levelMap = { L:QRCode.CorrectLevel.L, M:QRCode.CorrectLevel.M, Q:QRCode.CorrectLevel.Q, H:QRCode.CorrectLevel.H };

      // 创建新二维码
      qr = new QRCode(box, {
        text: value,
        width: size,
        height: size,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: levelMap[level] ?? QRCode.CorrectLevel.M
      });

      // 显示操作区
      document.getElementById('qrResult').style.display = 'block';
    }

    function getQRDataURL() {
      const box = document.getElementById('qrBox');
      const canvas = box.querySelector('canvas');
      const img = box.querySelector('img');
      if (canvas) return canvas.toDataURL('image/png');
      if (img && img.src) return img.src;
      return null;
    }

    function downloadQR() {
      const url = getQRDataURL();
      if (!url) return alert('暂无二维码，请先生成');
      const a = document.createElement('a');
      a.href = url; a.download = 'qrcode_' + Date.now() + '.png';
      document.body.appendChild(a); a.click(); a.remove();
    }

    async function shareQR() {
      const url = getQRDataURL();
      if (!url) return alert('暂无二维码，请先生成');
      const res = await fetch(url);
      const blob = await res.blob();
      const file = new File([blob], 'qrcode.png', { type: 'image/png' });
      if (navigator.share && navigator.canShare?.({ files:[file] })) {
        try { await navigator.share({ files:[file], title:'二维码', text:'分享二维码' }); }
        catch(e) { /* 用户取消 */ }
      } else {
        alert('此设备/浏览器不支持系统分享，请使用下载。');
      }
    }

    // ========= 二维码图片 -> 文字 =========
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const decodeResult = document.getElementById('decodeResult');
    const decodeText = document.getElementById('decodeText');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) handleImageFile(file);
    });
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault(); uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files?.[0];
      if (file && file.type.startsWith('image/')) handleImageFile(file);
    });

    function openCamera() {
      fileInput.setAttribute('capture', 'environment'); // 优先相机
      fileInput.click();
    }
    function openGallery() {
      fileInput.removeAttribute('capture'); // 相册/拍照二选
      fileInput.click();
    }

    function handleImageFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result; preview.style.display = 'block';
        decodeQRCode(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function decodeQRCode(imageSrc) {
      const img = new Image();
      img.onload = () => {
        // 为提速与内存安全，限制最长边 1600
        const maxSide = 1600;
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        const imageData = ctx.getImageData(0, 0, w, h);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:'attemptBoth' });

        if (code && code.data) {
          decodeText.value = code.data;
          decodeResult.style.display = 'block';
        } else {
          alert('未识别到二维码，请确保图片清晰且包含二维码');
        }
      };
      img.src = imageSrc;
    }

    // ========= 实时扫描 =========
    const liveCanvas = document.createElement('canvas');
    const liveCtx = liveCanvas.getContext('2d', { willReadFrequently:true });

    function startLiveScan() {
      const videoContainer = document.getElementById('videoContainer');
      const video = document.getElementById('video');
      const liveButton = document.getElementById('liveButton');

      videoContainer.style.display = 'block';
      liveButton.style.display = 'none';
      decodeResult.style.display = 'none';
      preview.style.display = 'none';

      navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          scanning = true;
          requestAnimationFrame(scanFrame);
        })
        .catch(err => {
          alert('无法访问摄像头: ' + (err.message || err));
          stopLiveScan();
        });
    }

    function scanFrame() {
      if (!scanning) return;
      const video = document.getElementById('video');
      if (video.readyState < 2) { requestAnimationFrame(scanFrame); return; }

      liveCanvas.width = video.videoWidth || 640;
      liveCanvas.height = video.videoHeight || 480;
      liveCtx.drawImage(video, 0, 0, liveCanvas.width, liveCanvas.height);

      const imageData = liveCtx.getImageData(0, 0, liveCanvas.width, liveCanvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:'attemptBoth' });

      if (code && code.data) {
        decodeText.value = code.data;
        decodeResult.style.display = 'block';
        stopLiveScan();
        if (navigator.vibrate) navigator.vibrate(200);
      } else {
        requestAnimationFrame(scanFrame);
      }
    }

    function stopLiveScan() {
      scanning = false;
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      document.getElementById('videoContainer').style.display = 'none';
      document.getElementById('liveButton').style.display = 'block';
    }

    // ========= 结果操作 =========
    function copyResult() {
      const txt = decodeText.value || '';
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(txt).then(() => alert('已复制到剪贴板！'));
      } else {
        decodeText.select(); document.execCommand('copy'); alert('已复制到剪贴板！');
      }
    }

    function openLink() {
      const t = (decodeText.value || '').trim();
      if (/^https?:\/\/[\w\-\.]/i.test(t)) window.open(t, '_blank');
      else alert('识别内容不是网址');
    }

    function resetScan() {
      preview.style.display = 'none';
      decodeResult.style.display = 'none';
      decodeText.value = '';
      fileInput.value = '';
    }

    // 离开页面时停止摄像头
    window.addEventListener('beforeunload', stopLiveScan);
  </script>
</body>
</html>
